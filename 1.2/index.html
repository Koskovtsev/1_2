<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <title>City Population Text Transformer</title>
</head>

<body>
    <script>
        "use strict"

        /* ---------- SOURCE DATA ---------- */

        const CSV_DATA = `
            48.30,32.16,Кропивницький,200000,
            44.38, 34.33, Алушта, 31440,
            49.46, 30.17, Біла Церква, 200131,
            49.54, 28.49, Бердичів, 87575, #некоммент

            #
            46.49, 36.58, #Бердянськ, 121692,
            49.15, 28.41, Вінниця, 356665,
            #45.40, 34.29, Джанкой, 43343,

            # в цьому файлі три рядки - коментаря :) 
            `;

        /* ---------- PARSING ---------- */

        function createCityTransformer() {
            let top10Cities = CSV_DATA
                .split(`\n`)
                .filter((line) => !(line.trim().startsWith('#') || line.trim() === ""))
                .map((line) => {
                    let elem = line.trim().split(',');
                    return {
                        x: +elem[0],
                        y: +elem[1],
                        name: elem[2].replace(/[^а-яіїєґ\-\'\’\ ]/gi, ""),
                        population: +elem[3]
                    }
                })
                .sort((a, b) => b.population - a.population)
                .slice(0, 10)
                .reduce((map, cityName, index) => {
                    name = cityName.name.toLowerCase().trim();
                    map[name] = {
                        population: cityName.population,
                        rate: index + 1
                    }
                    return map;
                }, {});
            const cityPattern = new RegExp(
                Object.keys(top10Cities).join('|'),
                "gi");
            function modifyCity(cityMatch) {
                let displayName = cityMatch.charAt(0).toUpperCase() + cityMatch.slice(1);
                const cityStats = top10Cities[cityMatch.toLowerCase()];
                return `${displayName} (${cityStats.rate} місце в ТОП-10 найбільших міст України, населення ${cityStats.population} людина/людини/людей)`;
            }
            return function (inputText) {
                return inputText.replace(cityPattern, modifyCity);
            }
        }

        /* ---------- TESTING ---------- */

        const transformText = createCityTransformer();
        console.log(transformText("Я перший раз у місті Кропивницький і другий раз у місті Алушта"));
        console.log(transformText("Вінниця - найкраще місто! Я його люблю!"));
    </script>
</body>

</html>